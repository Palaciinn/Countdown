<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parchís – MVP editable (inspirado Angel & Lily)</title>
  <style>
    :root{
      --bg:#0b0d10; --bg-soft:#12151b; --fg:#e7ecf3; --muted:#a6b0c0;
      --card:#0f1318; --border:#222833; --shadow:0 10px 30px rgba(0,0,0,.25);
      --radius:16px; --trans:.25s ease;
      --blue-1:#2563eb; --pink-1:#ec4899; --yellow-1:#f59e0b; --green-1:#10b981;
      --safe:#16a34a; --eligible:#0f1824;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}

    .topbar{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;box-shadow:var(--shadow)}
    .players{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .seat{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02)}
    .dot{width:12px;height:12px;border-radius:50%}.dot.blue{background:var(--blue-1)}.dot.pink{background:var(--pink-1)}
    .dot.yellow{background:var(--yellow-1)}.dot.green{background:var(--green-1)}
    .invite-btn{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1520;color:var(--fg);cursor:pointer}
    .status{display:flex;align-items:center;gap:10px;font-size:.95rem;color:var(--muted)}

    .board-area{margin-top:16px;display:grid;grid-template-columns:1fr 420px;gap:16px}
    @media (max-width:980px){.board-area{grid-template-columns:1fr}}

    .board{position:relative;aspect-ratio:1/1;width:100%;max-width:720px;margin:0 auto;background:var(--card);
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:8px;overflow:hidden}
    .board-15{position:absolute;inset:8px;display:grid;grid-template-columns:repeat(15,1fr);grid-template-rows:repeat(15,1fr);
      gap:2px;background:var(--border);border-radius:12px}
    .cell{position:relative;background:#0e141d;border:1px solid rgba(148,163,184,.12);user-select:none}
    .cell.center{background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02))}
    .cell.yard-blue{background:rgba(37,99,235,.12)}
    .cell.yard-pink{background:rgba(236,72,153,.12)}
    .cell.yard-yellow{background:rgba(245,158,11,.12)}
    .cell.yard-green{background:rgba(16,185,129,.12)}
    .cell.lane-blue{background:rgba(37,99,235,.28)}
    .cell.lane-pink{background:rgba(236,72,153,.28)}
    .cell.lane-yellow{background:rgba(245,158,11,.28)}
    .cell.lane-green{background:rgba(16,185,129,.28)}
    .cell.path{background:#141c27}
    .cell.safe{outline:2px solid var(--safe)}
    .cell .num{position:absolute;right:3px;top:2px;font-size:.55rem;color:#cbd5e1;opacity:.95;pointer-events:none}
    .cell .ord{position:absolute;left:3px;bottom:1px;font-size:.55rem;color:#94a3b8;opacity:.75;pointer-events:none}
    .cell.eligible:hover{outline:2px dashed #475569;cursor:pointer}
    .cell.selected{background:var(--eligible)!important;outline:2px solid #1f2937}

    .homes-overlay{position:absolute;inset:0;pointer-events:none}
    .home-group{position:absolute;display:grid;grid-template-columns:repeat(2,1fr);grid-auto-rows:clamp(36px,7vw,64px);gap:8px;padding:10px;border-radius:12px}
    .home-group.blue{left:4%;top:4%;width:34%;height:34%}
    .home-group.pink{right:4%;top:4%;width:34%;height:34%}
    .home-group.yellow{left:4%;bottom:4%;width:34%;height:34%}
    .home-group.green{right:4%;bottom:4%;width:34%;height:34%}
    .piece{width:100%;height:100%;border-radius:50%;border:2px solid rgba(0,0,0,.25)}
    .q-blue .piece{background:var(--blue-1)} .q-pink .piece{background:var(--pink-1)}
    .q-yellow .piece{background:var(--yellow-1)} .q-green .piece{background:var(--green-1)}

    .side{display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h3{margin:0 0 8px;font-size:1rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);
      background:#111827;color:var(--fg);cursor:pointer}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    textarea{width:100%;min-height:110px;background:#0f1520;color:#e5e7eb;border:1px solid var(--border);border-radius:10px;padding:8px;font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="players">
        <div class="seat"><span class="dot blue"></span><label><input type="checkbox" checked> Ángel</label></div>
        <div class="seat"><span class="dot pink"></span><label><input type="checkbox" checked> Lily</label></div>
        <div class="seat"><span class="dot yellow"></span><label><input type="checkbox"> Amarillo</label></div>
        <div class="seat"><span class="dot green"></span><label><input type="checkbox"> Verde</label></div>
      </div>
      <div class="status muted">Edita o carga el recorrido 1→68</div>
    </div>

    <div class="board-area">
      <div class="board">
        <div class="board-15" id="grid"></div>
        <div class="homes-overlay">
          <div class="home-group blue q-blue"></div>
          <div class="home-group pink q-pink"></div>
          <div class="home-group yellow q-yellow"></div>
          <div class="home-group green q-green"></div>
        </div>
      </div>

      <aside class="side">
        <div class="card">
          <h3>Recorrido (1→68)</h3>
          <div class="row" style="margin-bottom:8px">
            <button id="editBtn" class="btn">Editar</button>
            <button id="undoBtn" class="btn">Deshacer (⌫/Z)</button>
            <button id="clearBtn" class="btn">Borrar</button>
          </div>
          <div class="row" style="margin-bottom:8px">
            <button id="loadClassicBtn" class="btn">Plantilla “Anillo clásico”</button>
          </div>
          <div class="row">
            <button id="exportBtn" class="btn">Exportar</button>
            <button id="importBtn" class="btn">Importar</button>
          </div>
          <textarea id="io" placeholder="Aquí verás/pegarás el JSON del recorrido"></textarea>
          <p class="muted" id="progress">Progreso: 0 / 68</p>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const N=15, grid=document.getElementById('grid');
    const SAFE_SET=new Set([5,12,17,22,29,34,39,46,51,56,63,68]);
    const cells=[...Array(N)].map(()=>Array(N));

    // Construcción del tablero
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const el=document.createElement('div');
        el.className='cell'; el.dataset.r=r; el.dataset.c=c;

        const yardB=(r<6&&c<6), yardP=(r<6&&c>8), yardY=(r>8&&c<6), yardG=(r>8&&c>8);
        if(yardB) el.classList.add('yard-blue');
        if(yardP) el.classList.add('yard-pink');
        if(yardY) el.classList.add('yard-yellow');
        if(yardG) el.classList.add('yard-green');

        const inCenter=(r>=6&&r<=8&&c>=6&&c<=8); if(inCenter) el.classList.add('center');

        const laneB=(r>=1&&r<=5&&c===7), laneP=(c>=9&&c<=13&&r===7),
              laneY=(r>=9&&r<=13&&c===7), laneG=(c>=1&&c<=5&&r===7);
        if(laneB) el.classList.add('lane-blue');
        if(laneP) el.classList.add('lane-pink');
        if(laneY) el.classList.add('lane-yellow');
        if(laneG) el.classList.add('lane-green');

        // Sólo las que pueden formar el camino (excluimos patios, carriles y centro)
        if(!yardB&&!yardP&&!yardY&&!yardG&&!inCenter&&!laneB&&!laneP&&!laneY&&!laneG){
          el.classList.add('eligible');
        }

        el.addEventListener('click',()=>onCellClick(el));
        grid.appendChild(el); cells[r][c]=el;
      }
    }

    // Estado de edición
    let editing=false;
    let TRACK = JSON.parse(localStorage.getItem('parchisTrack')||'null');
    const editBtn=document.getElementById('editBtn');
    const undoBtn=document.getElementById('undoBtn');
    const clearBtn=document.getElementById('clearBtn');
    const loadClassicBtn=document.getElementById('loadClassicBtn');
    const exportBtn=document.getElementById('exportBtn');
    const importBtn=document.getElementById('importBtn');
    const io=document.getElementById('io');
    const progress=document.getElementById('progress');

    function setProgress(){
      progress.textContent=`Progreso: ${TRACK?TRACK.length:0} / 68`;
    }

    function onCellClick(el){
      if(!editing) return;
      if(!el.classList.contains('eligible')) return;
      if(el.dataset.order) return;

      if(!TRACK) TRACK=[];
      const n=TRACK.length+1;
      TRACK.push([+el.dataset.r,+el.dataset.c]);
      el.dataset.order=n;
      el.classList.add('selected');

      const label=document.createElement('span'); label.className='ord'; label.textContent=n; el.appendChild(label);
      if(SAFE_SET.has(n)) el.classList.add('safe');
      setProgress();
      if(n===68) applyTrackAndSave();
    }

    function clearVisual(){
      document.querySelectorAll('.cell').forEach(el=>{
        el.classList.remove('path','safe','selected');
        ['num','ord'].forEach(cls=>{const s=el.querySelector(`.${cls}`); if(s) s.remove();});
        delete el.dataset.order;
      });
    }

    function applyTrackAndSave(){
      localStorage.setItem('parchisTrack', JSON.stringify(TRACK));
      applyTrack(TRACK);
      editing=false; editBtn.textContent='Editar';
    }

    function applyTrack(track){
      clearVisual();
      track.forEach(([r,c],i)=>{
        const el=cells[r][c]; if(!el) return;
        el.classList.add('path');
        const n=i+1;
        const num=document.createElement('span'); num.className='num'; num.textContent=n; el.appendChild(num);
        if(SAFE_SET.has(n)) el.classList.add('safe');
      });
      setProgress();
    }

    function startEdit(){
      editing=true; editBtn.textContent='Finalizar';
      TRACK=[]; clearVisual(); setProgress();
    }

    function endEdit(){
      if(TRACK&&TRACK.length===68) applyTrackAndSave();
      else { editing=false; editBtn.textContent='Editar'; }
    }

    function undo(){
      if(!editing||!TRACK||TRACK.length===0) return;
      const [r,c]=TRACK.pop();
      const el=cells[r][c];
      if(el){
        if(el.querySelector('.ord')) el.querySelector('.ord').remove();
        el.classList.remove('selected','safe'); delete el.dataset.order;
      }
      setProgress();
    }

    function clearTrack(){
      localStorage.removeItem('parchisTrack'); TRACK=null; clearVisual(); setProgress();
    }

    // Plantilla “anillo clásico” (base buena para Wikipedia, luego puedes retocar 2–3 casillas si lo deseas)
    function loadClassic(){
      const t=[];
      // 1..7: subir por col 8 desde fila 14 a 8
      for(let r=14;r>=8;r--) t.push([r,8]);
      // 8..14: fila 8 hacia la izquierda hasta col 1 (dejamos 0 libre para giro superior)
      for(let c=7;c>=1;c--) t.push([8,c]);
      // 15..22: subir por col 0 desde fila 8 a 1 y luego 0
      t.push([8,0]); for(let r=7;r>=1;r--) t.push([r,0]); t.push([0,0]);
      // 23..34: fila 0 hacia la derecha hasta col 11 (borde superior)
      for(let c=1;c<=11;c++) t.push([0,c]);
      // 35..42: bajar por col 12..14 y seguir hasta fila 7
      t.push([0,12],[0,13],[0,14],[1,14],[2,14],[3,14],[4,14],[5,14]);
      // 43..50: continuar bajando hasta fila 14 (esquina inferior derecha)
      t.push([6,14],[7,14],[8,14],[9,14],[10,14],[11,14],[12,14],[13,14]);
      // 51..56: fila 14 hacia la izquierda hasta col 8
      for(let c=14;c>=9;c--) t.push([14,c]);
      // 57..63: subir por col 8 hasta fila 8
      for(let r=13;r>=8;r--) t.push([r,8]);
      // 64..68: fila 8 hacia la izquierda unas 5 casillas
      for(let c=7;c>=3;c--) t.push([8,c]);

      TRACK=t.slice(0,68);
      applyTrackAndSave();
    }

    // Exportar/Importar
    exportBtn.onclick=()=>{ io.value = JSON.stringify(TRACK||[], null, 2); io.select(); io.setSelectionRange(0, 99999); };
    importBtn.onclick=()=>{ try{ const t=JSON.parse(io.value); if(Array.isArray(t)&&t.length===68){ TRACK=t; applyTrackAndSave(); } }catch(e){ alert('JSON inválido'); } };

    editBtn.onclick=()=> editing ? endEdit() : startEdit();
    undoBtn.onclick=undo; clearBtn.onclick=clearTrack; loadClassicBtn.onclick=loadClassic;
    document.addEventListener('keydown',e=>{ if(e.key==='Backspace'||e.key.toLowerCase()==='z') undo(); });

    if(TRACK&&TRACK.length===68) applyTrack(TRACK); else setProgress();
  </script>
</body>
</html>
